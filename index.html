<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>皇家德州扑克 V2 (修复版)</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <style>
        :root {
            --table-green: #2e5936;
            --table-dark: #1a3320;
            --gold: #d4af37;
            --chip-red: #d63031;
            --chip-blue: #0984e3;
            --chip-green: #00b894;
            --card-w: 48px;
            --card-h: 70px;
        }

        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; }
        
        body {
            height: 100vh; width: 100vw; overflow: hidden;
            background: #111;
            font-family: 'Roboto Condensed', sans-serif;
            display: flex; flex-direction: column;
            color: white;
        }

        #table {
            position: relative; flex: 1; margin: 10px;
            background: radial-gradient(circle at center, var(--table-green) 0%, var(--table-dark) 80%);
            border: 6px solid #3e2723; border-radius: 60px;
            box-shadow: inset 0 0 50px rgba(0,0,0,0.8);
            display: flex; justify-content: center; align-items: center;
        }

        /* 公共牌 */
        #board-area {
            position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%);
            display: flex; gap: 6px; z-index: 10;
        }
        .slot {
            width: var(--card-w); height: var(--card-h);
            border: 2px dashed rgba(255,255,255,0.1); border-radius: 4px;
        }

        /* 底池 */
        #pot-display {
            position: absolute; top: 58%; left: 50%; transform: translate(-50%, 0);
            background: rgba(0,0,0,0.6); padding: 4px 12px; border-radius: 12px;
            border: 1px solid var(--gold); color: var(--gold); font-size: 14px;
        }

        /* 座位布局 */
        .seat { position: absolute; width: 80px; height: 90px; display: flex; flex-direction: column; align-items: center; }
        #seat-0 { bottom: 30px; left: 50%; transform: translateX(-50%); } 
        #seat-1 { left: 10px; top: 35%; transform: translateY(-50%); }
        #seat-2 { top: 10px; left: 50%; transform: translateX(-50%); }
        #seat-3 { right: 10px; top: 35%; transform: translateY(-50%); }

        .avatar {
            width: 54px; height: 54px; background: #333; border-radius: 50%;
            border: 3px solid #555; overflow: hidden; position: relative; z-index: 2;
            transition: all 0.3s;
        }
        .active-turn .avatar { border-color: var(--gold); box-shadow: 0 0 15px var(--gold); transform: scale(1.1); }
        
        .dealer-btn {
            position: absolute; width: 16px; height: 16px; background: white; color: black;
            border-radius: 50%; font-size: 10px; font-weight: bold; display: flex;
            justify-content: center; align-items: center; bottom: 30px; right: 0; z-index: 5;
            display: none; box-shadow: 0 1px 2px #000;
        }

        .player-info {
            background: rgba(0,0,0,0.8); border-radius: 4px; padding: 2px 0;
            margin-top: -12px; z-index: 3; text-align: center; width: 80px;
        }
        .p-name { font-size: 10px; color: #aaa; }
        .p-chips { font-size: 12px; color: var(--gold); font-weight: bold; }

        .hand-cards {
            position: absolute; display: flex; justify-content: center; top: 0; z-index: 1; 
        }
        #seat-0 .hand-cards { top: -50px; transform: scale(1.1); }
        .bot .hand-cards .card { transform: scale(0.8); margin-left: -20px; }
        .bot .hand-cards .card:first-child { margin-left: 0; }

        .action-bubble {
            position: absolute; top: -20px; background: #fff; color: #000;
            padding: 2px 8px; border-radius: 10px; font-size: 12px; font-weight: bold;
            opacity: 0; transition: all 0.3s; z-index: 20;
        }
        .action-bubble.show { opacity: 1; top: -30px; }

        /* 卡牌 */
        .card {
            width: var(--card-w); height: var(--card-h);
            background: #fff; border-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.5);
            position: relative; display: flex; flex-direction: column; align-items: center;
            font-family: 'Playfair Display', serif; margin: 0 2px;
        }
        .card.back {
            background: repeating-linear-gradient(45deg, #2c3e50, #2c3e50 5px, #34495e 5px, #34495e 10px);
            border: 2px solid #ecf0f1;
        }
        .card.red { color: #c0392b; }
        .card.black { color: #2d3436; }
        .card .rank { font-size: 20px; line-height: 1; margin-top: 2px; font-weight:bold; }
        .card .suit { font-size: 16px; }
        .card .big-suit { position: absolute; bottom: 2px; right: 2px; font-size: 22px; opacity: 0.2; }
        .winner-card { border: 2px solid var(--gold); box-shadow: 0 0 15px var(--gold); z-index: 100; transform: scale(1.1) !important;}

        /* 控制区 */
        #controls {
            height: 140px; background: #000; padding: 10px;
            display: flex; flex-direction: column; justify-content: space-between;
        }
        .slider-row { display: flex; align-items: center; gap: 10px; padding: 0 10px; visibility: hidden; }
        #raise-range { flex: 1; accent-color: var(--gold); height: 20px; }
        #raise-val { color: var(--gold); width: 60px; text-align: right; font-size: 14px; }

        .btn-row { display: flex; justify-content: space-between; gap: 8px; height: 50px; }
        .btn {
            flex: 1; border: none; border-radius: 4px;
            font-size: 14px; font-weight: bold; color: #fff;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            cursor: pointer; box-shadow: 0 3px 0 rgba(255,255,255,0.2);
        }
        .btn:active { transform: translateY(2px); box-shadow: none; }
        .btn:disabled { opacity: 0.3; pointer-events: none; filter: grayscale(1); }
        .btn-fold { background: #d63031; }
        .btn-check { background: #0984e3; }
        .btn-raise { background: #00b894; }
        .sub { font-size: 9px; opacity: 0.8; font-weight: normal; }

        /* 筹码动画 */
        .chip {
            position: absolute; width: 18px; height: 18px; border-radius: 50%;
            border: 2px dashed #fff; font-size: 7px; display: flex; 
            justify-content: center; align-items: center; color: #fff; z-index: 99;
        }
        .chip.red { background: var(--chip-red); }
        .chip.blue { background: var(--chip-blue); }
        .chip.green { background: var(--chip-green); }

        #overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.9); z-index: 200;
            display: none; justify-content: center; align-items: center; flex-direction: column;
        }
    </style>
</head>
<body>

<div id="table">
    <div id="board-area">
        <div class="slot" id="c-0"></div>
        <div class="slot" id="c-1"></div>
        <div class="slot" id="c-2"></div>
        <div class="slot" id="c-3"></div>
        <div class="slot" id="c-4"></div>
    </div>
    <div id="pot-display">Pot: <span id="pot-val">0</span></div>

    <div class="seat" id="seat-0">
        <div class="hand-cards" id="hand-0"></div>
        <div class="avatar"><img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Felix" width="100%"></div>
        <div class="dealer-btn" id="d-0">D</div>
        <div class="player-info"><div class="p-name">YOU</div><div class="p-chips" id="ch-0">0</div></div>
        <div class="action-bubble" id="act-0"></div>
    </div>
    <div class="seat bot" id="seat-1">
        <div class="hand-cards" id="hand-1"></div>
        <div class="avatar"><img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Jack" width="100%"></div>
        <div class="dealer-btn" id="d-1">D</div>
        <div class="player-info"><div class="p-name">Jack</div><div class="p-chips" id="ch-1">0</div></div>
        <div class="action-bubble" id="act-1"></div>
    </div>
    <div class="seat bot" id="seat-2">
        <div class="hand-cards" id="hand-2"></div>
        <div class="avatar"><img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Nala" width="100%"></div>
        <div class="dealer-btn" id="d-2">D</div>
        <div class="player-info"><div class="p-name">Nala</div><div class="p-chips" id="ch-2">0</div></div>
        <div class="action-bubble" id="act-2"></div>
    </div>
    <div class="seat bot" id="seat-3">
        <div class="hand-cards" id="hand-3"></div>
        <div class="avatar"><img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Bob" width="100%"></div>
        <div class="dealer-btn" id="d-3">D</div>
        <div class="player-info"><div class="p-name">Bob</div><div class="p-chips" id="ch-3">0</div></div>
        <div class="action-bubble" id="act-3"></div>
    </div>
</div>

<div id="controls">
    <div class="slider-row" id="slider-box">
        <span style="font-size:12px; color:#aaa">加注额:</span>
        <input type="range" id="raise-range" min="0" max="0" step="10">
        <span id="raise-val">0</span>
    </div>
    <div class="btn-row">
        <button class="btn btn-fold" id="btn-fold" onclick="game.humanAct('fold')">弃牌<span class="sub">Fold</span></button>
        <button class="btn btn-check" id="btn-check" onclick="game.humanAct('check')">过牌<span class="sub">Check</span></button>
        <button class="btn btn-raise" id="btn-raise" onclick="game.humanAct('raise')">加注<span class="sub">Raise</span></button>
    </div>
</div>

<div id="overlay" onclick="location.reload()">
    <h1 style="color:#d4af37; margin-bottom:10px;">GAME OVER</h1>
    <div style="color:#fff">点击屏幕重新开始</div>
</div>

<script>
const SUITS = ['♠', '♥', '♣', '♦'];
const RANKS = ['2','3','4','5','6','7','8','9','10','J','Q','K','A'];
const VALS = {'2':2,'3':3,'4':4,'5':5,'6':6,'7':7,'8':8,'9':9,'10':10,'J':11,'Q':12,'K':13,'A':14};

class Card {
    constructor(r, s) { this.r = r; this.s = s; this.v = VALS[r]; }
    get color() { return (this.s==='♥'||this.s==='♦')?'red':'black'; }
}

/* --- 牌型计算器 (简化版) --- */
const Eval = {
    rank: (cards) => {
        if (!cards || cards.length<5) return 0;
        cards.sort((a,b)=>b.v - a.v);
        // 简单评估：只看最大牌型权重 (用于Bot AI)
        // 8:同花顺, 7:四条, 6:葫芦, 5:同花, 4:顺子, 3:三条, 2:两对, 1:对子, 0:高牌
        let flush = Eval.isFlush(cards);
        let straight = Eval.isStraight(cards);
        let groups = Eval.groups(cards);
        let gKeys = Object.keys(groups);
        let maxG = Math.max(...Object.values(groups));
        
        if (flush && straight) return 800 + straight;
        if (maxG === 4) return 700 + parseInt(gKeys.find(k=>groups[k]===4));
        if (maxG === 3 && gKeys.length >= 2 && Object.values(groups).includes(2)) return 600;
        if (flush) return 500 + flush;
        if (straight) return 400 + straight;
        if (maxG === 3) return 300;
        if (gKeys.length === 3 && maxG === 2) return 200; // 3 groups with max 2 = 2 pairs
        if (maxG === 2) return 100;
        return cards[0].v;
    },
    isFlush: (c) => {
        let s = {}; c.forEach(x=>s[x.s]=(s[x.s]||0)+1);
        for(let k in s) if(s[k]>=5) return c.find(x=>x.s==k).v; // Return high card of flush
        return 0;
    },
    isStraight: (c) => {
        let v = [...new Set(c.map(x=>x.v))];
        if(v[0]===14) v.push(1); // A low
        for(let i=0; i<=v.length-5; i++) if(v[i]-v[i+4]===4) return v[i];
        return 0;
    },
    groups: (c) => {
        let m={}; c.forEach(x=>m[x.v]=(m[x.v]||0)+1);
        return m;
    }
};

class Game {
    constructor() {
        this.players = [
            { id:0, name:'YOU', chips:2000, hand:[], folded:false, bet:0, active:true },
            { id:1, name:'Jack', chips:2000, hand:[], folded:false, bet:0, active:true },
            { id:2, name:'Nala', chips:2000, hand:[], folded:false, bet:0, active:true },
            { id:3, name:'Bob', chips:2000, hand:[], folded:false, bet:0, active:true }
        ];
        this.dealer = 0;
        this.pot = 0;
        this.comm = [];
        this.deck = [];
        this.stage = 0; // 0:Pre, 1:Flop, 2:Turn, 3:River
        this.curBet = 0; // Current highest bet
        this.turn = 0;
        
        this.init();
    }

    init() {
        this.deck = [];
        for(let s of SUITS) for(let r of RANKS) this.deck.push(new Card(r,s));
        this.deck.sort(()=>Math.random()-0.5);

        this.pot = 0;
        this.comm = [];
        this.curBet = 0;
        this.players.forEach(p => {
            p.hand = []; p.folded = false; p.bet = 0; p.active = p.chips>0; p.acted = false;
            this.updateUI(p.id);
            document.getElementById(`act-${p.id}`).classList.remove('show');
            document.getElementById(`hand-${p.id}`).innerHTML = '';
        });
        document.getElementById('board-area').innerHTML = '<div class="slot"></div>'.repeat(5);

        // Blinds
        this.dealer = (this.dealer+1)%4;
        document.querySelectorAll('.dealer-btn').forEach(e=>e.style.display='none');
        document.getElementById(`d-${this.dealer}`).style.display='flex';

        let sb = (this.dealer+1)%4;
        let bb = (this.dealer+2)%4;
        this.bet(sb, 10);
        this.bet(bb, 20);
        this.curBet = 20;
        this.turn = (bb+1)%4;

        // Deal
        this.players.forEach(p => {
            if(p.active) {
                p.hand = [this.deck.pop(), this.deck.pop()];
                if(p.id===0) this.renderHand(0);
                else {
                    let h = document.getElementById(`hand-${p.id}`);
                    h.innerHTML = '<div class="card back"></div><div class="card back"></div>';
                }
            }
        });

        this.stage = 0;
        this.cycle();
    }

    cycle() {
        if(this.isRoundEnd()) {
            this.nextStage();
            return;
        }

        let p = this.players[this.turn];
        if(p.folded || p.chips===0) {
            this.nextTurn();
            return;
        }

        document.querySelectorAll('.seat').forEach(e=>e.classList.remove('active-turn'));
        document.getElementById(`seat-${this.turn}`).classList.add('active-turn');

        if(this.turn === 0) this.enableHuman();
        else setTimeout(() => this.botTurn(), 800);
    }

    humanAct(act) {
        let p = this.players[0];
        let diff = this.curBet - p.bet;

        if(act === 'fold') {
            p.folded = true;
            document.getElementById('hand-0').style.opacity = 0.5;
        } 
        else if(act === 'check' || act === 'call') {
            this.bet(0, diff);
        } 
        else if(act === 'raise') {
            // 关键修复：强制类型转换，防止字符串拼接
            let val = Number(document.getElementById('raise-range').value);
            // 最小加注逻辑
            if(val <= 0) val = 20; 
            let totalBet = this.curBet + val;
            let cost = totalBet - p.bet;
            
            if(cost > p.chips) cost = p.chips; // All in
            
            this.bet(0, cost);
            this.curBet = p.bet; // Update global high bet
            // Reset actions for others
            this.players.forEach(pl => { if(!pl.folded && pl.id!==0) pl.acted = false; });
        }

        this.showBubble(0, act.toUpperCase());
        p.acted = true;
        this.disableHuman();
        this.nextTurn();
    }

    botTurn() {
        let p = this.players[this.turn];
        let diff = this.curBet - p.bet;
        let act = 'fold';

        // 简单的AI决策
        let score = p.hand[0].v + p.hand[1].v;
        if(this.stage > 0) score = Eval.rank([...p.hand, ...this.comm]);

        // 随机决策因子
        let roll = Math.random();
        
        if (diff === 0) {
            if (score > 10 && roll > 0.7) act = 'raise';
            else act = 'check';
        } else {
            if (score > 15 || roll > 0.4) act = 'call';
            else act = 'fold';
        }

        if(act === 'raise') {
            let raiseAmt = 20;
            if(p.chips >= diff + raiseAmt) {
                this.bet(p.id, diff + raiseAmt);
                this.curBet = p.bet;
                this.players.forEach(pl => { if(!pl.folded && pl.id!==p.id) pl.acted = false; });
                this.showBubble(p.id, 'RAISE');
            } else {
                this.bet(p.id, p.chips);
                this.showBubble(p.id, 'ALL IN');
            }
        } else if (act === 'call') {
            this.bet(p.id, Math.min(diff, p.chips));
            this.showBubble(p.id, 'CALL');
        } else if (act === 'check') {
            this.showBubble(p.id, 'CHECK');
        } else {
            p.folded = true;
            document.getElementById(`hand-${p.id}`).style.opacity = 0.5;
            this.showBubble(p.id, 'FOLD');
        }

        p.acted = true;
        this.nextTurn();
    }

    nextTurn() {
        this.turn = (this.turn+1)%4;
        this.cycle();
    }

    isRoundEnd() {
        let active = this.players.filter(p=>!p.folded);
        if(active.length === 1) return true; // Win by fold
        // 所有人已行动且注码相等（或Allin）
        return active.every(p => (p.acted && (p.bet === this.curBet || p.chips === 0)));
    }

    nextStage() {
        // Clear bets
        this.players.forEach(p => { p.bet = 0; p.acted = false; });
        this.curBet = 0;
        
        let active = this.players.filter(p=>!p.folded);
        if(active.length === 1) { this.winner([active[0]]); return; }

        this.stage++;
        this.turn = (this.dealer+1)%4; // SB starts

        if(this.stage === 1) this.dealComm(3);
        else if(this.stage === 2 || this.stage === 3) this.dealComm(1);
        else if(this.stage === 4) { this.showdown(); return; }

        this.cycle();
    }

    bet(pid, amt) {
        let p = this.players[pid];
        if(amt > p.chips) amt = p.chips;
        p.chips -= amt;
        p.bet += amt;
        this.pot += amt;
        this.updateUI(pid);
        
        // Anim
        let chip = document.createElement('div');
        chip.className = `chip ${amt>=50?'red':(amt>=20?'blue':'green')}`;
        chip.innerText = amt;
        let rect = document.getElementById(`seat-${pid}`).getBoundingClientRect();
        chip.style.left = (rect.left+30)+'px'; chip.style.top = (rect.top+30)+'px';
        document.body.appendChild(chip);
        setTimeout(()=>{
            chip.style.left='50%'; chip.style.top='50%'; chip.style.opacity=0;
        },50);
        setTimeout(()=>chip.remove(),500);
    }

    dealComm(n) {
        let area = document.getElementById('board-area');
        let idx = this.comm.length;
        for(let i=0; i<n; i++) {
            let c = this.deck.pop();
            this.comm.push(c);
            let slot = document.getElementById(`c-${idx+i}`);
            slot.innerHTML = this.getCardHtml(c);
        }
    }

    showdown() {
        let active = this.players.filter(p=>!p.folded);
        // Show hands
        active.forEach(p => {
            if(p.id !== 0) {
                let h = document.getElementById(`hand-${p.id}`);
                h.innerHTML = '';
                p.hand.forEach(c => {
                    let d = document.createElement('div');
                    d.className = `card ${c.color}`;
                    d.innerHTML = this.getCardHtml(c);
                    h.appendChild(d);
                });
            }
        });

        // Find winner
        let best = -1;
        let winners = [];
        active.forEach(p => {
            let score = Eval.rank([...p.hand, ...this.comm]);
            if(score > best) { best = score; winners = [p]; }
            else if(score === best) winners.push(p);
        });
        
        this.winner(winners);
    }

    winner(ws) {
        let share = Math.floor(this.pot / ws.length);
        ws.forEach(w => {
            w.chips += share;
            this.showBubble(w.id, 'WINNER');
            this.updateUI(w.id);
            // Highlight
            let h = document.getElementById(`hand-${w.id}`);
            Array.from(h.children).forEach(c=>c.classList.add('winner-card'));
        });
        
        setTimeout(()=> {
            if(this.players[0].chips <= 0) document.getElementById('overlay').style.display='flex';
            else this.init();
        }, 3000);
    }

    /* --- UI Helpers --- */
    enableHuman() {
        let p = this.players[0];
        let diff = this.curBet - p.bet;
        let maxRaise = p.chips - diff;

        document.getElementById('btn-fold').disabled = false;
        
        let ck = document.getElementById('btn-check');
        ck.innerHTML = diff===0 ? '过牌<div class="sub">Check</div>' : `跟注 ${diff}<div class="sub">Call</div>`;
        ck.onclick = () => this.humanAct(diff===0 ? 'check' : 'call');
        ck.disabled = false;

        let rs = document.getElementById('btn-raise');
        let sl = document.getElementById('slider-box');
        let rng = document.getElementById('raise-range');
        
        if(maxRaise >= 20) {
            rs.disabled = false;
            sl.style.visibility = 'visible';
            rng.max = maxRaise;
            rng.value = 20;
            document.getElementById('raise-val').innerText = 20;
            rng.oninput = (e) => document.getElementById('raise-val').innerText = e.target.value;
        } else {
            rs.disabled = true;
            sl.style.visibility = 'hidden';
        }
    }

    disableHuman() {
        document.querySelectorAll('.btn').forEach(b=>b.disabled=true);
        document.getElementById('slider-box').style.visibility = 'hidden';
    }

    updateUI(pid) {
        document.getElementById(`ch-${pid}`).innerText = this.players[pid].chips;
        document.getElementById(`pot-val`).innerText = this.pot;
    }

    renderHand(pid) {
        let div = document.getElementById(`hand-${pid}`);
        div.innerHTML = '';
        this.players[pid].hand.forEach(c => {
            let d = document.createElement('div');
            d.className = `card ${c.color}`;
            d.innerHTML = this.getCardHtml(c);
            div.appendChild(d);
        });
    }

    getCardHtml(c) {
        return `<div class="rank">${c.r}</div><div class="suit">${c.s}</div><div class="big-suit">${c.s}</div>`;
    }

    showBubble(pid, txt) {
        let b = document.getElementById(`act-${pid}`);
        b.innerText = txt; b.classList.add('show');
        setTimeout(()=>b.classList.remove('show'), 2000);
    }
}

const game = new Game();
</script>
</body>
</html>
